name: Dev_Landing

on:
  push:
    branches:
      - development

jobs:
  pm2-configuration:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v3
        with:
          node-version: "16.13.1"
      - name: INSTALL NODE MODULES
        run: npm i
      - name: CHANGE LANDING PORT
        run: |
          new_port="4000"  
          json_file="package.json"
          if grep -q '"start": "next start' "$json_file"; then
            sed -i -E 's/"start": "next start.*-p [0-9]+/"start": "next start -p '"$new_port"'"/' "$json_file"
            echo "Port added successfully! ðŸš€ðŸš€ðŸš€ðŸš€ðŸš€ðŸš€"
          else
            sed -i -E 's/"start": "next start"/"start": "next start -p '"$new_port"'"/' "$json_file"
            echo "Port updated successfully! ðŸš€ðŸš€ðŸš€ðŸš€ðŸš€ðŸš€"
          fi
      - name: CHAGNE PROJECT UTILS
        run: echo -e "export const isProduction = false;" > projectUtils.js
      - name: BUILD PROJECT
        run: npm run build
      - name: INSTALL SSH KEY
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SECRET }}
          known_hosts: "unnecessary"
      - name: ADDING KNOWS KEYS
        run: ssh-keyscan -H ${{ secrets.HOST }} >> ~/.ssh/known_hosts

      - name: MOVE BUILD FILES TO THE SERVER
        run: rsync -avz -e "ssh -p ${{ secrets.PORT }}" ./ ${{ secrets.USER }}@${{ secrets.HOST }}:/root/dev/matjarbot-landing-page/

      - name: RESTART THE PM2 SERVER
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SECRET }}
          script: |
            cd dev/matjarbot-landing-page
            chmod -R a+x .
            pm2 restart dev-landing
